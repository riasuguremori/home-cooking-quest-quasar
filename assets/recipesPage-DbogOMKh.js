import{Q as J}from"./QToolbarTitle-uhcdwykv.js";import{Q as M}from"./QMenu-DHbgiscJ.js";import{z as v,ac as L,h as b,o as d,j as r,f as K,b as n,e as t,Q as p,M as G,S as u,L as H,af as W,a0 as X,ad as Y,$ as N,t as A,a as y,c as f,F as U,i as _,ae as Z}from"./index-CCltDTcc.js";import{Q as ee}from"./QToolbar-DVqQvwW-.js";import{Q}from"./QImg-48OQTr1V.js";import{a as le,Q as B}from"./QTable-D19l5PzE.js";import{Q as ae}from"./QRating-Bnr8WG8o.js";import{Q as te}from"./QEditor-CAwAF0_9.js";import{Q as P}from"./QVirtualScroll-CF7Nsi2E.js";import{Q as oe}from"./QForm-CoHpBmVC.js";import{Q as se}from"./QPage-DfUJbLHa.js";import{u as ie}from"./use-quasar-CUmE3VzD.js";import{r as q}from"./recipe-CWeHbSy1.js";import"./position-engine-DhZ2HoGy.js";import"./selection-CUV_63Hm.js";import"./use-fullscreen-CrZqwLof.js";import"./format-hlGAdIUH.js";import"./QTooltip-BAXmC6CC.js";import"./QList-D8PYKg1x.js";import"./QChip-X1ikjzpS.js";import"./QItemLabel-7_chNhSH.js";const ne={class:"q-pa-md"},re={class:"row"},de={class:"col-12"},ue={class:"text-h6"},me={class:"row items-center q-mt-md"},ce={class:"q-py-md"},pe={class:"col"},ge={class:"col"},fe={key:0,class:"col-auto"},ve={class:"col-auto"},Ve={class:"q-py-md"},be={class:"col"},ye={class:"col"},we={class:"col"},he={class:"col"},xe={class:"col"},Ue={class:"q-py-md"},_e={class:"row items-center q-mb-sm"},Qe={class:"col-auto text-subtitle1"},Ge={__name:"recipesPage",setup(qe){const c=ie(),k=v([]),w=v(""),V=v(!1),h=L("mainImageAgent"),m=v({open:!1,id:""}),C=()=>({name:"",description:"",ingredients:[{name:"",quantity:""}],steps:[{description:"",files:[],rawFiles:[]}],category:"",unlockPrice:0,status:"發佈",image:[],rawImage:[],existingImage:null,rating:0,nutrition:[{calories:0,protein:0,fat:0,carbs:0,netCarbs:0}]}),a=v(C()),$=["中式","日式","西式","甜點","其他"],R=["草稿","發佈","隱藏"],T=()=>{a.value.ingredients.push({name:"",quantity:""})},z=i=>{a.value.ingredients.splice(i,1)},D=()=>{a.value.steps.push({description:"",files:[],rawFiles:[]})},O=i=>{a.value.steps.splice(i,1)},j=[{name:"image",label:"圖片",field:"imageUrl",align:"left"},{name:"name",label:"食譜名字",field:"name",align:"left",sortable:!0},{name:"category",label:"分類",field:"category",align:"left",sortable:!0},{name:"unlockPrice",label:"解鎖積分",field:"unlockPrice",align:"right",sortable:!0},{name:"status",label:"食譜狀態",field:"status",format:i=>i||"未知",align:"left",sortable:!0},{name:"author",label:"作者",field:i=>i.author.account,align:"left",sortable:!0},{name:"createdAt",label:"創建日期",field:"createdAt",format:i=>new Date(i).toLocaleString(),align:"left",sortable:!0},{name:"actions",label:"操作",align:"center"}],I=async()=>{try{const{data:i}=await q.getAllRecipes();k.value=i.result}catch{c.notify({message:"取得食譜失敗",color:"negative"})}},F=i=>{if(m.value.open=!0,i){m.value.id=i._id;const o=JSON.parse(JSON.stringify(i));a.value={...o,image:[],existingImage:i.imageUrl,nutrition:i.nutrition&&i.nutrition.length>0?i.nutrition:[{calories:0,protein:0,fat:0,carbs:0,netCarbs:0}],steps:i.steps.map(g=>({description:g.description,image:g.imageUrl,files:[],rawFiles:[]}))}}else m.value.id="",a.value=C();h.value&&h.value.deleteFileRecord()},S=()=>{m.value.open=!1},E=async()=>{if(a.value.image.some(s=>s.error)){c.notify({message:"主圖片格式不符或檔案過大",color:"negative"});return}if(!m.value.id&&a.value.image.length===0){c.notify({message:"請上傳主圖片",color:"negative"});return}for(let s=0;s<a.value.steps.length;s++){const l=a.value.steps[s];if(!l.description.trim()){c.notify({message:`步驟 ${s+1} 請輸入說明`,color:"negative"});return}if(l.files.some(x=>x.error)){c.notify({message:`步驟 ${s+1} 的圖片格式不符或檔案過大`,color:"negative"});return}}const i=new FormData;["name","description","ingredients","nutrition","category","unlockPrice","rating","status"].forEach(s=>{s==="ingredients"||s==="nutrition"?i.append(s,JSON.stringify(a.value[s])):i.append(s,a.value[s])});let g=0;const e=a.value.steps.map(s=>{const x=s.files.length>0&&s.files[0].file?g++:-1;return{description:s.description,image:s.image||null,fileIndex:x}});i.append("steps",JSON.stringify(e)),a.value.image.length>0&&i.append("image",a.value.image[0].file),a.value.steps.forEach(s=>{s.files.length>0&&s.files[0].file&&i.append("stepImages",s.files[0].file)});try{V.value=!0,m.value.id?(await q.updateRecipe(m.value.id,i),c.notify({message:"更新成功",color:"positive"})):(await q.createRecipe(i),c.notify({message:"新增成功",color:"positive"})),S(),I()}catch(s){console.log(s);const l=s?.response?.data?.message||"發生錯誤";c.notify({message:l,color:"negative"})}finally{V.value=!1}};return I(),(i,o)=>{const g=K("VueFileAgent");return d(),b(se,{padding:""},{default:r(()=>[n("div",ne,[n("div",re,[n("div",de,[t(le,{rows:k.value,columns:j,"row-key":"_id",flat:"",bordered:"",filter:w.value},{top:r(()=>[t(ee,null,{default:r(()=>[t(J,null,{default:r(()=>[...o[11]||(o[11]=[G("食譜管理",-1)])]),_:1}),t(M),t(u,{modelValue:w.value,"onUpdate:modelValue":o[0]||(o[0]=e=>w.value=e),dense:"",debounce:"500",placeholder:"搜尋",color:"primary"},{append:r(()=>[t(H,{name:"search"})]),_:1},8,["modelValue"]),t(p,{color:"primary",icon:"add",label:"新增食譜",onClick:o[1]||(o[1]=e=>F(null)),class:"q-ml-md"})]),_:1})]),"body-cell-image":r(e=>[t(B,{props:e},{default:r(()=>[t(Q,{src:e.value,style:{width:"100px",height:"auto"}},null,8,["src"])]),_:2},1032,["props"])]),"body-cell-actions":r(e=>[t(B,{props:e},{default:r(()=>[t(p,{icon:"edit",flat:"",round:"",onClick:s=>F(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","filter"])])])]),t(W,{modelValue:m.value.open,"onUpdate:modelValue":o[10]||(o[10]=e=>m.value.open=e),persistent:""},{default:r(()=>[t(X,{style:{"min-width":"80vw","max-width":"80vw"}},{default:r(()=>[t(oe,{onSubmit:Y(E,["prevent"])},{default:r(()=>[t(N,null,{default:r(()=>[n("div",ue,A(m.value.id?"編輯食譜":"新增食譜"),1)]),_:1}),t(N,{class:"q-gutter-md"},{default:r(()=>[t(u,{modelValue:a.value.name,"onUpdate:modelValue":o[2]||(o[2]=e=>a.value.name=e),label:"食譜名稱",rules:[e=>!!e||"請輸入食譜名稱"]},null,8,["modelValue","rules"]),n("div",me,[o[12]||(o[12]=n("div",{class:"text-subtitle1 q-mr-md"},"難易度",-1)),t(ae,{modelValue:a.value.rating,"onUpdate:modelValue":o[3]||(o[3]=e=>a.value.rating=e),max:"5",size:"2em",color:"orange",icon:"star_border","icon-selected":"star"},null,8,["modelValue"])]),o[16]||(o[16]=n("div",{class:"text-h6 q-mt-lg"},"封面",-1)),a.value.image.length===0&&a.value.existingImage?(d(),b(Q,{key:0,src:a.value.existingImage,style:{width:"200px",height:"auto","margin-bottom":"10px","border-radius":"8px"}},null,8,["src"])):y("",!0),t(g,{ref_key:"mainImageAgent",ref:h,modelValue:a.value.image,"onUpdate:modelValue":o[4]||(o[4]=e=>a.value.image=e),"raw-model-value":a.value.rawImage,"onUpdate:rawModelValue":o[5]||(o[5]=e=>a.value.rawImage=e),accept:"image/png,image/jpeg,image/jpg",deletable:"","max-files":1,"max-size":"1MB","help-text":"選擇檔案或拖曳到這裡","error-text":{type:"檔案格式不支援",size:"檔案大小不能超過 1MB"}},null,8,["modelValue","raw-model-value"]),t(te,{modelValue:a.value.description,"onUpdate:modelValue":o[6]||(o[6]=e=>a.value.description=e),"min-height":"10rem",placeholder:"食譜說明"},null,8,["modelValue"]),n("div",ce,[o[13]||(o[13]=n("div",{class:"text-h6 q-mb-sm"},"食材內容",-1)),(d(!0),f(U,null,_(a.value.ingredients,(e,s)=>(d(),f("div",{key:s,class:"row q-col-gutter-sm q-mb-md items-start"},[n("div",pe,[t(u,{modelValue:e.name,"onUpdate:modelValue":l=>e.name=l,rules:[l=>!!l||"請輸入食材名稱"],filled:"",label:"食材名稱",dense:""},null,8,["modelValue","onUpdate:modelValue","rules"])]),n("div",ge,[t(u,{modelValue:e.quantity,"onUpdate:modelValue":l=>e.quantity=l,rules:[l=>!!l||"請輸入食材份量"],filled:"",label:"食材份量",dense:""},null,8,["modelValue","onUpdate:modelValue","rules"])]),a.value.ingredients.length>1?(d(),f("div",fe,[t(p,{icon:"delete",flat:"",round:"",color:"negative",class:"q-mt-xs",onClick:l=>z(s)},null,8,["onClick"])])):y("",!0)]))),128)),n("div",ve,[t(p,{label:"新增食材",icon:"add",color:"primary",outline:"",class:"full-width",onClick:T})])]),n("div",Ve,[o[14]||(o[14]=n("div",{class:"text-h6 q-mb-sm"},"營養標示",-1)),(d(!0),f(U,null,_(a.value.nutrition,(e,s)=>(d(),f("div",{key:s,class:"row q-col-gutter-sm q-mb-md items-start"},[n("div",be,[t(u,{modelValue:e.calories,"onUpdate:modelValue":l=>e.calories=l,rules:[l=>!!l||"請輸入熱量"],filled:"",label:"熱量",dense:""},null,8,["modelValue","onUpdate:modelValue","rules"])]),n("div",ye,[t(u,{modelValue:e.protein,"onUpdate:modelValue":l=>e.protein=l,rules:[l=>!!l||"請輸入蛋白質"],filled:"",label:"蛋白質",dense:""},null,8,["modelValue","onUpdate:modelValue","rules"])]),n("div",we,[t(u,{modelValue:e.fat,"onUpdate:modelValue":l=>e.fat=l,rules:[l=>!!l||"請輸入脂肪"],filled:"",label:"脂肪",dense:""},null,8,["modelValue","onUpdate:modelValue","rules"])]),n("div",he,[t(u,{modelValue:e.carbs,"onUpdate:modelValue":l=>e.carbs=l,rules:[l=>!!l||"請輸入碳水化合物"],filled:"",label:"碳水化合物",dense:""},null,8,["modelValue","onUpdate:modelValue","rules"])]),n("div",xe,[t(u,{modelValue:e.netCarbs,"onUpdate:modelValue":l=>e.netCarbs=l,rules:[l=>!!l||"請輸入淨碳水"],filled:"",label:"淨碳水",dense:""},null,8,["modelValue","onUpdate:modelValue","rules"])])]))),128))]),n("div",Ue,[o[15]||(o[15]=n("div",{class:"text-h6 q-mb-sm"},"步驟",-1)),(d(!0),f(U,null,_(a.value.steps,(e,s)=>(d(),f("div",{key:s},[e.files.length===0&&e.image?(d(),b(Q,{key:0,src:e.image,style:{width:"100px","margin-bottom":"5px"}},null,8,["src"])):y("",!0),n("div",_e,[n("div",Qe,"步驟 "+A(s+1),1),t(M),a.value.steps.length>1?(d(),b(p,{key:0,icon:"delete",flat:"",round:"",color:"negative",onClick:l=>O(s)},null,8,["onClick"])):y("",!0)]),t(u,{modelValue:e.description,"onUpdate:modelValue":l=>e.description=l,type:"textarea",label:"步驟說明",rules:[l=>!!l||"請輸入步驟說明"],filled:"",class:"q-mb-sm"},null,8,["modelValue","onUpdate:modelValue","rules"]),t(g,{modelValue:e.files,"onUpdate:modelValue":l=>e.files=l,"raw-model-value":e.rawFiles,"onUpdate:rawModelValue":l=>e.rawFiles=l,accept:"image/png,image/jpeg,image/jpg",deletable:"","max-files":50,multiple:"","max-size":"1MB","help-text":"選擇此步驟的圖片 (可選)","error-text":{type:"檔案格式不支援",size:"檔案大小不能超過 1MB"}},null,8,["modelValue","onUpdate:modelValue","raw-model-value","onUpdate:rawModelValue"])]))),128)),t(p,{label:"新增步驟",onClick:D,color:"primary",class:"q-mt-md"})]),t(P,{modelValue:a.value.category,"onUpdate:modelValue":o[7]||(o[7]=e=>a.value.category=e),options:$,label:"分類",rules:[e=>!!e||"請選擇分類"]},null,8,["modelValue","rules"]),t(u,{modelValue:a.value.unlockPrice,"onUpdate:modelValue":o[8]||(o[8]=e=>a.value.unlockPrice=e),modelModifiers:{number:!0},type:"number",label:"解鎖積分",rules:[e=>e>=0||"積分不能小於 0"]},null,8,["modelValue","rules"]),t(P,{modelValue:a.value.status,"onUpdate:modelValue":o[9]||(o[9]=e=>a.value.status=e),options:R,label:"狀態","emit-value":"","map-options":"",rules:[e=>e!==null||"請選擇狀態"]},null,8,["modelValue","rules"])]),_:1}),t(Z,{align:"right",class:"q-pa-md"},{default:r(()=>[t(p,{flat:"",label:"取消",color:"negative",onClick:S,disable:V.value},null,8,["disable"]),t(p,{type:"submit",label:"儲存",color:"primary",loading:V.value},null,8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}};export{Ge as default};
