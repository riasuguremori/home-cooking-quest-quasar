import{z as q,ac as oe,I as B,B as H,f as ie,h as w,o as g,j as t,e,a0 as F,$ as A,b as d,P as U,t as h,Q,c as $,a as M,S as j,au as se,av as ne,L,M as k,ae as re,af as W,aw as de,F as P,i as E,O as R,N as T,w as ue,p as D,n as ce,g as me,R as ge}from"./index-CCltDTcc.js";import{a as I,b as _,Q as N}from"./QList-D8PYKg1x.js";import{Q as fe,a as ve}from"./QVirtualScroll-CF7Nsi2E.js";import{Q as pe}from"./QPage-DfUJbLHa.js";import{Q as be}from"./QPageContainer-CLUIcwg7.js";import{u as J}from"./use-quasar-CUmE3VzD.js";import{a as z}from"./article-B42tPgpF.js";import{Q as X,a as ye}from"./QMenu-DHbgiscJ.js";import{Q as Y}from"./QImg-48OQTr1V.js";import{Q as S}from"./QItemLabel-7_chNhSH.js";import{Q as he}from"./QForm-CoHpBmVC.js";import{C as O}from"./ClosePopup-DfjdXHmb.js";import{c as G}from"./comment-D-Ok87oV.js";import{Q as _e}from"./QChip-X1ikjzpS.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./format-hlGAdIUH.js";import"./position-engine-DhZ2HoGy.js";import"./selection-CUV_63Hm.js";const xe={class:"text-h6 text-weight-bold"},we={key:0,class:"q-mb-sm"},Ve={__name:"ArticleEditDialog",props:{modelValue:{type:Boolean,required:!0},id:{type:String,default:""},initialData:{type:Object,default:()=>({})},categoryOptions:{type:Array,default:()=>[]}},emits:["update:modelValue","saved"],setup(l,{emit:V}){const s=l,v=V,p=J(),m=q(!1),r=oe("mainImageAgent"),f=B(),b=()=>({title:"",content:"",description:"",category:"",image:[],rawImage:[],existingImage:null}),o=q(b());H(()=>s.modelValue,u=>{if(u){if(s.id&&s.initialData){const a=JSON.parse(JSON.stringify(s.initialData));o.value={...a,image:[],existingImage:s.initialData.imageUrl}}else o.value=b();setTimeout(()=>{r.value&&r.value.deleteFileRecord()},100)}});const C=async()=>{if(o.value.image.some(a=>a.error))return p.notify({message:"主圖片格式不符或檔案過大",color:"negative"});if(!s.id&&o.value.image.length===0)return p.notify({message:"請上傳圖片",color:"negative"});const u=new FormData;u.append("title",o.value.title),u.append("content",o.value.content),u.append("category",o.value.category),o.value.image.length>0&&o.value.image.forEach(a=>u.append("image",a.file));try{m.value=!0;const{data:a}=await(s.id?z.updateArticle(s.id,u):z.createArticle(u));a.log&&f.pointLog.push(a.log),p.notify({message:s.id?"文章更新成功":"文章發布成功",color:"positive",icon:"check_circle"}),v("saved"),v("update:modelValue",!1)}catch(a){console.log(a),p.notify({color:"negative",message:"發布失敗",icon:"report_problem",position:"bottom"})}finally{m.value=!1}};return(u,a)=>{const y=ie("VueFileAgent");return g(),w(W,{"model-value":l.modelValue,"onUpdate:modelValue":a[5]||(a[5]=c=>u.$emit("update:modelValue",c)),persistent:""},{default:t(()=>[e(F,{style:{"min-width":"500px","max-width":"90vw"},class:"rounded-borders"},{default:t(()=>[e(A,{class:"row items-center q-pb-none"},{default:t(()=>[d("div",xe,h(l.id?"編輯文章":"新增文章"),1),e(X),U(e(Q,{icon:"close",flat:"",round:"",dense:""},null,512),[[O]])]),_:1}),e(A,null,{default:t(()=>[e(he,{onSubmit:C,class:"q-gutter-md"},{default:t(()=>[e(j,{modelValue:o.value.title,"onUpdate:modelValue":a[0]||(a[0]=c=>o.value.title=c),label:"標題",outlined:"",rules:[c=>!!c||"請輸入標題"]},null,8,["modelValue","rules"]),o.value.image.length===0&&o.value.existingImage&&o.value.existingImage.length>0?(g(),$("div",we,[a[6]||(a[6]=d("div",{class:"text-caption text-grey"},"目前圖片",-1)),e(Y,{src:o.value.existingImage,style:{width:"200px",height:"auto","margin-bottom":"10px","border-radius":"8px"},fit:"cover"},null,8,["src"])])):M("",!0),e(y,{ref_key:"mainImageAgent",ref:r,modelValue:o.value.image,"onUpdate:modelValue":a[1]||(a[1]=c=>o.value.image=c),"raw-model-value":o.value.rawImage,"onUpdate:rawModelValue":a[2]||(a[2]=c=>o.value.rawImage=c),accept:"image/png,image/jpeg,image/jpg",deletable:"",maxFiles:4,multiple:"","max-size":"1MB","help-text":"選擇檔案或拖曳到這裡","error-text":{type:"檔案格式不支援",size:"檔案大小不能超過 1MB"}},null,8,["modelValue","raw-model-value"]),e(fe,{modelValue:o.value.category,"onUpdate:modelValue":a[3]||(a[3]=c=>o.value.category=c),options:l.categoryOptions,"option-label":"label","option-value":"label","emit-value":"","map-options":"",label:"分類",outlined:"",rules:[c=>!!c||"請選擇分類"]},{option:t(c=>[e(I,se(ne(c.itemProps)),{default:t(()=>[e(_,{avatar:""},{default:t(()=>[e(L,{name:c.opt.icon},null,8,["name"])]),_:2},1024),e(_,null,{default:t(()=>[e(S,null,{default:t(()=>[k(h(c.opt.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","rules"]),e(j,{modelValue:o.value.content,"onUpdate:modelValue":a[4]||(a[4]=c=>o.value.content=c),type:"textarea",label:"內容",outlined:"",rows:"10",rules:[c=>!!c||"請輸入內容"]},null,8,["modelValue","rules"]),e(re,{align:"right",class:"q-pa-md"},{default:t(()=>[U(e(Q,{flat:"",label:"取消",color:"negative",disable:m.value},null,8,["disable"]),[[O]]),e(Q,{type:"submit",label:"送出",color:"primary",loading:m.value},null,8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model-value"])}}},qe={key:0,class:"row justify-center q-pa-md"},ke={key:1,class:"text-center text-grey q-pa-md"},Ce=["src"],$e={__name:"ArticleCommentDialog",props:{modelValue:{type:Boolean,required:!0},articleId:{type:String,default:""}},emits:["update:modelValue","comment-added"],setup(l,{emit:V}){const s=l,v=V,p=J(),m=B(),r=q([]),f=q(!1),b=q(""),o=async()=>{if(s.articleId){f.value=!0;try{const{data:u}=await G.getArticleComment(s.articleId);r.value=u.result}catch(u){console.error(u)}finally{f.value=!1}}};H(()=>s.modelValue,u=>{u&&(r.value=[],b.value="",o())});const C=async()=>{if(!m.isLoggedIn){p.notify({color:"warning",message:"請先登入",icon:"warning",position:"bottom"});return}if(b.value.trim())try{const u={content:b.value,article:s.articleId},{data:a}=await G.createComment(u);r.value.unshift({...a.result,author:{account:m.account}}),b.value="",v("comment-added")}catch(u){console.log(u),p.notify({color:"negative",message:"留言失敗",icon:"report_problem",position:"bottom"})}};return(u,a)=>(g(),w(W,{"model-value":l.modelValue,"onUpdate:modelValue":a[1]||(a[1]=y=>u.$emit("update:modelValue",y))},{default:t(()=>[e(F,{style:{"min-width":"500px","max-width":"90vw"},class:"rounded-borders"},{default:t(()=>[e(A,{class:"row items-center q-pb-none"},{default:t(()=>[a[2]||(a[2]=d("div",{class:"text-h6 text-weight-bold"},"留言",-1)),e(X),U(e(Q,{icon:"close",flat:"",round:"",dense:""},null,512),[[O]])]),_:1}),e(A,{style:{"max-height":"60vh"},class:"scroll"},{default:t(()=>[f.value?(g(),$("div",qe,[e(de,{color:"deep-orange",size:"2em"})])):r.value.length===0?(g(),$("div",ke," 尚未有留言，成為第一個留言的人吧！ ")):(g(),w(N,{key:2,separator:""},{default:t(()=>[(g(!0),$(P,null,E(r.value,y=>(g(),w(I,{key:y._id},{default:t(()=>[e(_,{avatar:"",top:""},{default:t(()=>[e(R,{size:"md"},{default:t(()=>[d("img",{src:`https://api.dicebear.com/9.x/thumbs/svg?seed=${y.author?.account}`},null,8,Ce)]),_:2},1024)]),_:2},1024),e(_,null,{default:t(()=>[e(S,{class:"text-weight-bold"},{default:t(()=>[k(h(y.author?.account||"匿名"),1)]),_:2},1024),e(S,{caption:""},{default:t(()=>[k(h(new Date(y.createdAt).toLocaleString()),1)]),_:2},1024),e(S,{class:"q-mt-xs text-body2 text-grey-9"},{default:t(()=>[k(h(y.content),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}))]),_:1}),e(T),e(A,{class:"bg-grey-1"},{default:t(()=>[e(j,{modelValue:b.value,"onUpdate:modelValue":a[0]||(a[0]=y=>b.value=y),outlined:"",dense:"",placeholder:"寫下你的想法...","bg-color":"white",onKeyup:ue(C,["enter"])},{after:t(()=>[e(Q,{round:"",dense:"",flat:"",icon:"send",color:"deep-orange",onClick:C,disable:!b.value.trim()},null,8,["disable"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}},Qe=["src"],Ae={key:0,class:"row q-col-gutter-xs q-mt-sm"},Ie={class:"text-h6 text-weight-bold q-mt-sm q-mb-xs"},Se={class:"text-body2 text-grey-8 q-mb-md"},Ue={class:"row q-gutter-sm q-mb-md"},Le={class:"row items-center justify-between"},De={class:"row q-gutter-x-md"},ze={class:"row items-center"},Oe={class:"text-grey-6 text-caption q-ml-xs"},je={class:"text-weight-medium"},Be={__name:"ArticleCard",props:{article:{type:Object,required:!0}},emits:["edit","delete","like","comment","share"],setup(l){const V=l,s=B(),v=D(()=>V.article.likes.includes(s._id)),p=D(()=>s.isAdmin||V.article.author?._id===s._id);return(m,r)=>(g(),w(F,{flat:"",class:"bg-white q-mb-lg rounded-borders post-card"},{default:t(()=>[e(I,null,{default:t(()=>[e(_,{avatar:""},{default:t(()=>[e(R,null,{default:t(()=>[d("img",{src:`https://api.dicebear.com/9.x/thumbs/svg?seed=${l.article.author?.account}`},null,8,Qe)]),_:1})]),_:1}),e(_,null,{default:t(()=>[e(S,{class:"text-weight-bold"},{default:t(()=>[k(h(l.article.author?.account||"匿名"),1)]),_:1}),e(S,{caption:""},{default:t(()=>[k(h(new Date(l.article.createdAt).toLocaleDateString()),1)]),_:1})]),_:1}),e(_,{side:""},{default:t(()=>[p.value?(g(),w(Q,{key:0,flat:"",round:"",icon:"more_horiz"},{default:t(()=>[e(ye,null,{default:t(()=>[e(N,{style:{"min-width":"100px"}},{default:t(()=>[U((g(),w(I,{clickable:"",onClick:r[0]||(r[0]=f=>m.$emit("edit",l.article))},{default:t(()=>[e(_,null,{default:t(()=>[...r[5]||(r[5]=[k("編輯",-1)])]),_:1})]),_:1})),[[O]]),U((g(),w(I,{clickable:"",onClick:r[1]||(r[1]=f=>m.$emit("delete",l.article._id))},{default:t(()=>[e(_,{class:"text-negative"},{default:t(()=>[...r[6]||(r[6]=[k("刪除",-1)])]),_:1})]),_:1})),[[O]])]),_:1})]),_:1})]),_:1})):M("",!0)]),_:1})]),_:1}),l.article.imageUrl&&l.article.imageUrl.length>0?(g(),$("div",Ae,[(g(!0),$(P,null,E(l.article.imageUrl,(f,b)=>(g(),$("div",{key:b,class:ce({"col-12":l.article.imageUrl.length===1,"col-6":l.article.imageUrl.length===2||l.article.imageUrl.length===4,"col-4":l.article.imageUrl.length===3||l.article.imageUrl.length>=5})},[e(Y,{src:f,ratio:l.article.imageUrl.length===1?4/3:1,fit:"cover",class:"rounded-borders",style:me(l.article.imageUrl.length===1?"":"height: 200px")},null,8,["src","ratio","style"])],2))),128))])):M("",!0),e(A,null,{default:t(()=>[d("div",Ie,h(l.article.title),1),d("div",Se,h(l.article.content),1),d("div",Ue,[e(_e,{color:"orange-1","text-color":"deep-orange",size:"sm",class:"text-weight-bold"},{default:t(()=>[k(h(l.article.category),1)]),_:1})]),e(T,{class:"q-my-md",color:"grey-2"}),d("div",Le,[d("div",De,[d("div",ze,[e(Q,{flat:"",round:"",dense:"",icon:v.value?"favorite":"favorite_border",color:v.value?"red":"grey-5",size:"sm",onClick:r[2]||(r[2]=f=>m.$emit("like",l.article))},null,8,["icon","color"]),d("span",Oe,h(l.article.likes.length),1)]),d("div",{class:"flex items-center text-grey-6 cursor-pointer",onClick:r[3]||(r[3]=f=>m.$emit("comment",l.article))},[e(L,{name:"chat_bubble_outline",size:"20px",class:"q-mr-xs"}),d("span",je,h(l.article.comments||0),1)]),d("div",{class:"flex items-center text-grey-6 cursor-pointer",onClick:r[4]||(r[4]=f=>m.$emit("share"))},[e(L,{name:"share",size:"20px"})])])])]),_:1})]),_:1}))}},Fe=K(Be,[["__scopeId","data-v-3193ddf4"]]),Pe={class:"row items-center q-mb-md"},Ee={class:"text-grey-5 text-weight-bold"},Ne=["src"],Me={class:"text-weight-bold text-grey-9"},Re={__name:"ArticleLeaderboard",props:{leaderboard:{type:Array,required:!0}},setup(l){return(V,s)=>(g(),w(F,{flat:"",class:"bg-white q-mb-lg rounded-borders"},{default:t(()=>[e(A,null,{default:t(()=>[d("div",Pe,[e(L,{name:"emoji_events",color:"deep-orange",class:"q-mr-sm",size:"xs"}),s[0]||(s[0]=d("div",{class:"text-subtitle1 text-weight-bold"},"總發文數排行榜",-1))]),e(N,{class:"q-gutter-y-sm"},{default:t(()=>[(g(!0),$(P,null,E(l.leaderboard,(v,p)=>(g(),w(I,{key:v._id,class:"q-px-none"},{default:t(()=>[e(_,{avatar:"",class:"q-pr-sm",style:{"min-width":"20px"}},{default:t(()=>[d("span",Ee,h(p+1),1)]),_:2},1024),e(_,{avatar:""},{default:t(()=>[e(R,{size:"36px"},{default:t(()=>[d("img",{src:`https://api.dicebear.com/9.x/thumbs/svg?seed=${v.account}`},null,8,Ne)]),_:2},1024)]),_:2},1024),e(_,null,{default:t(()=>[e(S,{class:"text-weight-bold"},{default:t(()=>[k(h(v.account),1)]),_:2},1024)]),_:2},1024),e(_,{side:""},{default:t(()=>[d("div",Me,h(v.count),1),s[1]||(s[1]=d("div",{class:"text-caption text-grey-5",style:{"font-size":"10px"}},"POSTS",-1))]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}))}},Te=K(Re,[["__scopeId","data-v-14145ede"]]),Je={class:"row q-col-gutter-lg max-width-container full-width"},Ke={class:"col-12 col-md-3 gt-sm"},Ge={class:"col-12 col-md-6"},He={class:"row q-mb-md items-center"},We={class:"col-12 col-md-3 gt-sm"},Xe={__name:"articlePage",setup(l){const V=[{label:"所有文章",icon:"feed"},{label:"公告",icon:"local_fire_department"},{label:"閒聊",icon:"emoji_people"},{label:"提問",icon:"psychology_alt"},{label:"分享",icon:"volunteer_activism"},{label:"曬圖",icon:"camera_enhance"}],s=q(V[0].label),v=q(""),p=B(),m=J(),r=D(()=>V.filter(i=>i.label==="所有文章"?!1:i.label==="公告"?p.isAdmin:!0)),f=q({open:!1,id:""}),b=q({}),o=q([]),C=q({open:!1,articleId:""}),u=D(()=>o.value.filter(i=>{const x=s.value==="所有文章"||i.category===s.value,n=!v.value||i.title&&i.title.toLowerCase().includes(v.value.toLowerCase())||i.content&&i.content.toLowerCase().includes(v.value.toLowerCase());return x&&n})),a=D(()=>{const i=new Map;return o.value.forEach(x=>{const n=x.author;!n||!n._id||(i.has(n._id)||i.set(n._id,{_id:n._id,account:n.account,count:0}),i.get(n._id).count++)}),Array.from(i.values()).sort((x,n)=>n.count-x.count).slice(0,5)}),y=async()=>{try{const{data:i}=await z.getAllArticle();o.value=i.result}catch{m.notify({message:"取得文章失敗",color:"negative"})}};y();const c=i=>{if(!p.isLoggedIn){m.notify({color:"warning",message:"請先登入後再發布文章",icon:"warning",position:"bottom"});return}f.value.open=!0,i?(f.value.id=i._id,b.value=i):(f.value.id="",b.value={})},Z=async i=>{try{await z.deleteArticle(i),m.notify({message:"刪除成功",color:"positive",icon:"check_circle"}),y()}catch{m.notify({message:"刪除失敗",color:"negative",icon:"report_problem"})}},ee=async i=>{if(!p.isLoggedIn){m.notify({color:"warning",message:"請先登入",icon:"warning",position:"bottom"});return}try{const{data:x}=await z.likeArticle(i._id);if(x.isLiked)i.likes.push(p._id);else{const n=i.likes.indexOf(p._id);n>-1&&i.likes.splice(n,1)}}catch{m.notify({message:"操作失敗",color:"negative"})}},te=()=>{navigator.clipboard.writeText(window.location.href),m.notify({message:"連結已複製",color:"positive",icon:"content_copy",position:"bottom"})},ae=async i=>{C.value.open=!0,C.value.articleId=i._id};return(i,x)=>(g(),w(be,null,{default:t(()=>[e(pe,{class:"q-pa-md flex justify-center"},{default:t(()=>[d("div",Je,[d("div",Ke,[e(N,{class:"q-mb-lg"},{default:t(()=>[(g(),$(P,null,E(V,(n,le)=>U(e(I,{key:le,clickable:"",active:s.value===n.label,"active-class":"bg-orange-2 text-deep-orange-7",class:"rounded-borders",onClick:Ye=>s.value=n.label},{default:t(()=>[e(_,{avatar:""},{default:t(()=>[e(L,{name:n.icon},null,8,["name"])]),_:2},1024),e(_,{class:"text-weight-bold"},{default:t(()=>[k(h(n.label),1)]),_:2},1024)]),_:2},1032,["active","onClick"]),[[ge]])),64))]),_:1})]),d("div",Ge,[d("div",He,[e(j,{modelValue:v.value,"onUpdate:modelValue":x[0]||(x[0]=n=>v.value=n),dense:"",outlined:"",rounded:"",placeholder:"搜尋文章",class:"col","bg-color":"white"},{prepend:t(()=>[e(L,{name:"search"})]),_:1},8,["modelValue"]),e(Q,{class:"q-ml-md",color:"deep-orange",icon:"add",label:"新增文章",rounded:"",unelevated:"",onClick:c})]),e(T,{class:"q-mb-md",color:"orange-2"}),e(ve,{items:u.value,class:"full-width","scroll-target":"window","virtual-scroll-item-size":450},{default:t(({item:n})=>[(g(),w(Fe,{key:n._id,article:n,onEdit:c,onDelete:Z,onLike:ee,onComment:ae,onShare:te},null,8,["article"]))]),_:1},8,["items"])]),d("div",We,[e(Te,{leaderboard:a.value},null,8,["leaderboard"])])]),e(Ve,{modelValue:f.value.open,"onUpdate:modelValue":x[1]||(x[1]=n=>f.value.open=n),id:f.value.id,"initial-data":b.value,"category-options":r.value,onSaved:y},null,8,["modelValue","id","initial-data","category-options"]),e($e,{modelValue:C.value.open,"onUpdate:modelValue":x[2]||(x[2]=n=>C.value.open=n),"article-id":C.value.articleId,onCommentAdded:y},null,8,["modelValue","article-id"])]),_:1})]),_:1}))}},bt=K(Xe,[["__scopeId","data-v-f0381aa8"]]);export{bt as default};
